<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>wifi observer</title>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/dc.min.css">
        <script src="js/d3.min.js"></script>
        <script src="js/crossfilter.min.js"></script>
        <script src="js/dc.min.js"></script>
        <style>
            #linechart-conn-time, #linechart-dhcp-time {
                margin-top: -20px;
            }
            #linechart-conn-time svg g.axis.y,
            #linechart-dhcp-time svg g.axis.y {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>wifi observer</h1>
            <div id="datacount-projects">
                <p>
                    Showing <span class="filter-count"></span> out of <span class="total-count"></span> connections.
                    <a href='javascript:dc.filterAll(); dc.renderAll();'>Reset Filters</a>
                </p>
            </div>
            <div style="clear:both;"></div>

            <div>
                <h4>BSSID</h4>
                <div id="rowchart-bssid"></div>
            </div>
            <div>
                <h4>Connection</h4>
                <div id="piechart-conn"></div>
            </div>
            <div>
                <h4>DHCP</h4>
                <div id="piechart-dhcp"></div>
            </div>
            <div>
                <h4>SSID</h4>
                <div id="piechart-ssid"></div>
            </div>
            <div style="clear:both;"></div>

            <div>
                <h4>Failed Connections / Hour</h4>
                <div id="linechart-conn-failure"></div>
                <div id="linechart-conn-time"></div>
            </div>
            <div style="clear:both;"></div>

            <div>
                <h4>Failed DHCP / Hour</h4>
                <div id="linechart-dhcp-failure"></div>
                <div id="linechart-dhcp-time"></div>
            </div>
            <div style="clear:both;"></div>

            <table id="datatable-projects" class="table table-condensed table-hover">
                <thead>
                <tr class="header">
                    <th>Timestamp</th>
                    <th>Connection</th>
                    <th>DHCP</th>
                    <th>SSID</th>
                    <th>BSSID</th>
                    <th>DB ID</th>
                </tr>
                </thead>
            </table>
        </div>
        <script>
            var colors_red    = ['#FF545A'];
            var colors_rg     = ['#D62728', '#2CA02C'];
            var colors_rgg    = ['#D62728', '#2CA02C', '#7F7F7F'];
            var colors_duo    = ['#1F77B4', '#9ADA81'];
            var colors_custom = '#7F7F7F #1F77B4 #9467BD #8C564B #E377C2 #17BECF #FF7F0E #BCBD22'.split(' ');
            var date_format   = d3.time.format.utc('%Y-%m-%d %H:%M:%S');

            d3.csv("wifi-observer.csv", function(data) {
                return parse(data);
            }, function(error, data) {
                if (error) {
                    console.log(error);
                } else {
                    visualize(data);
                }
            });

            function parse(data) {
                return {
                    id:        data.id,
                    timestamp: date_format.parse(data.timestamp),
                    conn:      data.conn,
                    dhcp:      data.dhcp,
                    ssid:      data.ssid,
                    bssid:     data.bssid,
                };
            };

            function visualize(data) {

                var cf  = crossfilter(data);

                var dim_id    = cf.dimension(function(d) { return d.id; });
                var dim_conn  = cf.dimension(function(d) { return d.conn; });
                var dim_dhcp  = cf.dimension(function(d) { return d.dhcp; });
                var dim_ssid  = cf.dimension(function(d) { return d.ssid; });
                var dim_bssid = cf.dimension(function(d) { return d.bssid; });
                var dim_hour  = cf.dimension(function(d) { return d3.time.hour(d.timestamp); });

                var group_conn  = dim_conn.group().reduceCount();
                var group_dhcp  = dim_dhcp.group().reduceCount();
                var group_ssid  = dim_ssid.group().reduceCount();
                var group_bssid = dim_bssid.group().reduceCount();
                var group_const = dim_hour.group().reduce(
                    function reduceAdd(p, v) { return p; },
                    function reduceRemove(p, v) { return p; },
                    function reduceInitial() { return 0; }
                );
                var group_conn_fails = dim_hour.group().reduceSum(function(d) { return d.conn == '0' ? 1 : 0; });
                var group_dhcp_fails = dim_hour.group().reduceSum(function(d) { return d.dhcp == '0' ? 1 : 0; });

                var timerange = [d3.min(data,function(d){return d.timestamp}), d3.max(data,function(d){return d.timestamp})];

                dc.dataCount("#datacount-projects")
                    .dimension(cf)
                    .group(cf.groupAll());

                dc.pieChart("#piechart-conn")
                    .width(250)
                    .height(250)
                    .dimension(dim_conn)
                    .group(group_conn)
                    .ordinalColors(colors_rg)
                    .label(function(d) { return d.key == 1 ? 'success' : 'failure'; })
                    .title(function(d) { return d.value; });

                dc.pieChart("#piechart-dhcp")
                    .width(250)
                    .height(250)
                    .dimension(dim_dhcp)
                    .group(group_dhcp)
                    .ordinalColors(colors_rgg)
                    .label(function(d) {
                        if (d.key == '1'){
                            return 'success';
                        } else if (d.key == '0'){
                            return 'failure';
                        } else {
                            return d.key;
                        }
                    })
                    .title(function(d) { return d.value; });

                dc.pieChart("#piechart-ssid")
                    .width(250)
                    .height(250)
                    .dimension(dim_ssid)
                    .group(group_ssid)
                    .ordinalColors(colors_duo)
                    .label(function(d) { return d.key; })
                    .title(function(d) { return d.value; });

                dc.rowChart("#rowchart-bssid")
                    .width(350)
                    .height(350)
                    .dimension(dim_bssid)
                    .group(group_bssid)
                    .ordinalColors(colors_custom)
                    .labelOffsetX(5)
                    .label(function(d) { return d.key; })
                    .title(function(d) { return d.value; })
                    .elasticX(false)
                    .x(d3.scale.log().clamp(true).domain([1, 15000]).range([0,350]).nice());

                var conntime = dc.lineChart("#linechart-conn-time");
                conntime
                    .renderArea(true)
                    .mouseZoomable(false)
                    .width(1150)
                    .height(70)
                    .dimension(dim_hour)
                    .group(group_const)
                    .x(d3.time.scale().domain(timerange))
                    .round(d3.time.hour.round)
                    .xUnits(d3.time.hours)
                    .yAxisLabel('zoom')
                    .yAxis().ticks([]);

                dc.lineChart("#linechart-conn-failure")
                    .rangeChart(conntime)
                    .renderArea(true)
                    .mouseZoomable(false)
                    .width(1150)
                    .height(200)
                    .ordinalColors(colors_red)
                    .dimension(dim_hour)
                    .group(group_conn_fails)
                    .x(d3.time.scale().domain(timerange))
                    .round(d3.time.hour.round)
                    .xUnits(d3.time.hours);

                var dhcptime = dc.lineChart("#linechart-dhcp-time");
                dhcptime
                    .renderArea(true)
                    .mouseZoomable(false)
                    .width(1150)
                    .height(70)
                    .dimension(dim_hour)
                    .group(group_const)
                    .x(d3.time.scale().domain(timerange))
                    .round(d3.time.hour.round)
                    .xUnits(d3.time.hours)
                    .yAxisLabel('zoom')
                    .yAxis().ticks([]);

                dc.lineChart("#linechart-dhcp-failure")
                    .rangeChart(dhcptime)
                    .renderArea(true)
                    .mouseZoomable(false)
                    .width(1150)
                    .height(200)
                    .ordinalColors(colors_red)
                    .dimension(dim_hour)
                    .group(group_dhcp_fails)
                    .x(d3.time.scale().domain(timerange))
                    .round(d3.time.hour.round)
                    .xUnits(d3.time.hours)
                    .xAxis();

                dc.dataTable("#datatable-projects")
                    .dimension(dim_id)
                    .group(function (d) { return ''; })
                    .size(50)
                    .columns([
                        function (d) { return d.timestamp; },
                        function (d) { return d.conn == 1 ? 'success' : 'failure' ; },
                        function (d) {
                            if (d.dhcp == '1'){
                                return 'success';
                            } else if (d.dhcp == '0'){
                                return 'failure';
                            } else {
                                return d.dhcp;
                            }
                        },
                        function (d) { return d.ssid; },
                        function (d) { return d.bssid; },
                        function (d) { return d.id; }
                    ])
                    .sortBy(function (d) { return +d.id; })
                    .order(d3.ascending);

                dc.renderAll();
            }
        </script>
    </body>
</html>
